<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Automation</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
    }
    nav {
      display: flex;
      background: #007bff;
      padding: 10px;
      color: white;
      justify-content: space-between;
      align-items: center;
    }
    nav h2 {
      margin: 0;
    }
    nav button {
      background: #0056b3;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .container {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h3 {
      margin-top: 0;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    .status { font-weight: bold; }
    .on { color: green; }
    .off { color: red; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <nav>
    <h2>Home Automation</h2>
    <button onclick="logout()">Logout</button>
  </nav>

  <div class="container">

    <!-- Login -->
    <div id="loginCard" class="card">
      <h3>Login</h3>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <button onclick="signup()">Sign Up</button>
    </div>

    <!-- Control Panel -->
    <div id="controlCard" class="card hidden">
      <h3>Control Panel</h3>
      <p>Lamp 1: <span id="lamp1-status" class="status">...</span></p>
      <button onclick="toggleLamp('lamp1')">Toggle Lamp 1</button>
      <p>Lamp 2: <span id="lamp2-status" class="status">...</span></p>
      <button onclick="toggleLamp('lamp2')">Toggle Lamp 2</button>
      <p>NodeMCU Status: <span id="online-status" class="status">...</span></p>
    </div>

    <!-- Settings -->
    <div id="settingsCard" class="card hidden">
      <h3>Wi-Fi Setup</h3>
      <select id="wifiList"></select>
      <input type="password" id="wifiPass" placeholder="Wi-Fi Password">
      <button onclick="connectWiFi()">Connect</button>
      <button onclick="scanWiFi()">Rescan</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminCard" class="card hidden">
      <h3>Admin: Add Allowed Email</h3>
      <input type="email" id="newEmail" placeholder="New allowed email">
      <button onclick="addAllowedEmail()">Add Email</button>
    </div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBTsypZYdo6spPGG9W9MEeckgcetefDP3M",
      authDomain: "h4xcontrol.firebaseapp.com",
      databaseURL: "https://h4xcontrol-default-rtdb.firebaseio.com",
      projectId: "h4xcontrol",
      storageBucket: "h4xcontrol.appspot.com",
      messagingSenderId: "1030967330576",
      appId: "1:1030967330576:web:ac3e4201a61b5bebea8795",
      measurementId: "G-Z20VN8LY3N"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const adminEmails = ["contact@hashir.site", "admin@h4x.com"];

    auth.onAuthStateChanged(async user => {
      if (user) {
        const email = user.email;
        const allowedSnap = await db.ref("allowed_users").once("value");
        const allowed = allowedSnap.val() || {};
        if (!allowed[email.replace(/\./g, "_")]) {
          alert("This email is not allowed. Logging out.");
          logout();
          return;
        }

        show("controlCard");
        show("settingsCard");
        if (adminEmails.includes(email)) show("adminCard");
        hide("loginCard");

        updateStatus("lamp1");
        updateStatus("lamp2");
        db.ref("online").on("value", snap => {
          const el = document.getElementById("online-status");
          el.textContent = snap.val() ? "Online" : "Offline";
          el.className = "status " + (snap.val() ? "on" : "off");
        });

        scanWiFi();

      } else {
        hide("controlCard");
        hide("settingsCard");
        hide("adminCard");
        show("loginCard");
      }
    });

    function login() {
      const email = emailVal();
      const pass = passVal();
      auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
    }

    async function signup() {
      const email = emailVal();
      const pass = passVal();
      const allowedSnap = await db.ref("allowed_users").once("value");
      const allowed = allowedSnap.val() || {};
      if (!allowed[email.replace(/\./g, "_")]) {
        alert("â›” This email is not allowed to register.");
        return;
      }
      auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
    }

    function logout() {
      auth.signOut();
    }

    function toggleLamp(lamp) {
      const ref = db.ref(lamp);
      ref.once("value").then(snap => ref.set(!snap.val()));
    }

    function updateStatus(lamp) {
      const el = document.getElementById(`${lamp}-status`);
      db.ref(lamp).on("value", snap => {
        el.textContent = snap.val() ? "ON" : "OFF";
        el.className = "status " + (snap.val() ? "on" : "off");
      });
    }

    function scanWiFi() {
      db.ref("wifi_scan").set(true); // NodeMCU will detect this and scan
      setTimeout(async () => {
        const snap = await db.ref("wifi_list").once("value");
        const wifiList = snap.val() || [];
        const select = document.getElementById("wifiList");
        select.innerHTML = "";
        wifiList.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }, 3000); // Give NodeMCU time to scan
    }

    function connectWiFi() {
      const ssid = document.getElementById("wifiList").value;
      const pass = document.getElementById("wifiPass").value;
      db.ref("wifi_credentials").set({ ssid, password: pass });
      alert("Wi-Fi credentials sent. Wait a few seconds...");
    }

    function addAllowedEmail() {
      const email = document.getElementById("newEmail").value.trim();
      if (!email) return alert("Enter a valid email");
      const safeKey = email.replace(/\./g, "_");
      db.ref("allowed_users/" + safeKey).set(true)
        .then(() => alert("Email added!"))
        .catch(e => alert(e.message));
    }

    function emailVal() {
      return document.getElementById("email").value.trim();
    }
    function passVal() {
      return document.getElementById("password").value.trim();
    }

    function show(id) {
      document.getElementById(id).classList.remove("hidden");
    }
    function hide(id) {
      document.getElementById(id).classList.add("hidden");
    }
  </script>
</body>
</html>
