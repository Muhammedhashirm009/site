<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Automation</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
    }

    .container {
      max-width: 500px;
      margin: 50px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
      position: relative;
    }

    h2 {
      margin-bottom: 20px;
      color: #333;
    }

    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    .secondary {
      background-color: #6c757d;
    }

    .secondary:hover {
      background-color: #5a6268;
    }

    .status {
      font-weight: bold;
      font-size: 16px;
    }

    .on { color: green; }
    .off { color: red; }

    .hidden { display: none; }

    .settings-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 24px;
    }

    .settings-panel {
      display: none;
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }

    .section {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Settings Button -->
  <div class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</div>

  <!-- Login Card -->
  <div id="loginCard">
    <h2>üîê Login</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button class="secondary" onclick="signup()">Sign Up</button>
  </div>

  <!-- Control Panel -->
  <div id="controlCard" class="hidden">
    <h2>üè† Control Panel</h2>
    <p>Lamp 1: <span id="lamp1-status" class="status">...</span></p>
    <button onclick="toggleLamp('lamp1')">Toggle Lamp 1</button>
    <p>Lamp 2: <span id="lamp2-status" class="status">...</span></p>
    <button onclick="toggleLamp('lamp2')">Toggle Lamp 2</button>
    <button class="secondary" onclick="logout()" style="margin-top: 20px;">Logout</button>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel">
      <div class="section">
        <h3>üì∂ Wi-Fi Settings</h3>
        <button onclick="rescanWifi()">Rescan</button>
        <ul id="wifiList"></ul>
        <div id="wifiConnect" class="hidden">
          <input type="text" id="wifiPassword" placeholder="Enter Wi-Fi Password" />
          <button onclick="connectWifi()">Connect</button>
        </div>
      </div>

      <div class="section" id="adminPanel" class="hidden">
        <h3>üë§ Add Allowed User</h3>
        <input type="email" id="newUserEmail" placeholder="Enter Email" />
        <button onclick="addAllowedUser()">Add Email</button>
      </div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBTsypZYdo6spPGG9W9MEeckgcetefDP3M",
    authDomain: "h4xcontrol.firebaseapp.com",
    databaseURL: "https://h4xcontrol-default-rtdb.firebaseio.com",
    projectId: "h4xcontrol",
    storageBucket: "h4xcontrol.appspot.com",
    messagingSenderId: "1030967330576",
    appId: "1:1030967330576:web:ac3e4201a61b5bebea8795"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUserEmail = null;

  function toggleSettings() {
    const panel = document.getElementById("settingsPanel");
    panel.style.display = panel.style.display === "none" || panel.style.display === "" ? "block" : "none";
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUserEmail = user.email;
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("controlCard").classList.remove("hidden");
      updateStatus("lamp1");
      updateStatus("lamp2");
      checkAdminAccess();
    } else {
      document.getElementById("loginCard").classList.remove("hidden");
      document.getElementById("controlCard").classList.add("hidden");
    }
  });

  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  }

  function signup() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;

    db.ref("allowed_users").once("value").then(snap => {
      const allowed = snap.val() || {};
      if (allowed[email]) {
        auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
      } else {
        alert("‚õî This email is not allowed to register.");
      }
    });
  }

  function logout() {
    auth.signOut();
  }

  function updateStatus(lamp) {
    const el = document.getElementById(`${lamp}-status`);
    db.ref(lamp).on('value', snap => {
      const val = snap.val();
      el.textContent = val ? "ON" : "OFF";
      el.className = `status ${val ? 'on' : 'off'}`;
    });
  }

  function toggleLamp(lamp) {
    const ref = db.ref(lamp);
    ref.once('value').then(snap => {
      ref.set(!snap.val());
    });
  }

  function rescanWifi() {
    db.ref("wifi/request_scan").set(true);
    db.ref("wifi/scan_results").once("value").then(snap => {
      const list = snap.val() || [];
      const ul = document.getElementById("wifiList");
      ul.innerHTML = "";
      list.forEach(ssid => {
        const li = document.createElement("li");
        li.textContent = ssid;
        li.style.cursor = "pointer";
        li.onclick = () => {
          db.ref("wifi/selected_ssid").set(ssid);
          document.getElementById("wifiConnect").classList.remove("hidden");
        };
        ul.appendChild(li);
      });
    });
  }

  function connectWifi() {
    const pass = document.getElementById("wifiPassword").value;
    db.ref("wifi/selected_password").set(pass);
    alert("Password sent to device.");
  }

  function addAllowedUser() {
    const newEmail = document.getElementById("newUserEmail").value;
    if (!newEmail) return alert("Enter a valid email.");
    db.ref("allowed_users/" + newEmail.replace(/\./g, ",")).set(true).then(() => {
      alert("User added.");
    });
  }

  function checkAdminAccess() {
    const adminPanel = document.getElementById("adminPanel");
    if (currentUserEmail === "contact@hashir.site") {
      adminPanel.style.display = "block";
    } else {
      adminPanel.style.display = "none";
    }
  }
</script>
</body>
</html>
