<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Automation</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f2f5;
    }
    header {
      background: #007bff;
      padding: 15px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    .settings-icon {
      cursor: pointer;
      font-size: 22px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 400px;
      margin: 30px auto;
    }
    h2 {
      margin-bottom: 20px;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }
    button:hover {
      background-color: #0056b3;
    }
    .secondary {
      background-color: #6c757d;
    }
    .secondary:hover {
      background-color: #5a6268;
    }
    .hidden {
      display: none;
    }
    .status {
      font-weight: bold;
      font-size: 16px;
    }
    .on { color: green; }
    .off { color: red; }
  </style>
</head>
<body>

<header>
  <h1>Home Automation</h1>
  <div class="settings-icon" onclick="toggleSettings()">⚙️</div>
</header>

<!-- Login -->
<div id="loginCard" class="card">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"/>
  <input type="password" id="password" placeholder="Password"/>
  <button onclick="login()">Login</button>
  <button class="secondary" onclick="signup()">Sign Up</button>
</div>

<!-- Control Panel -->
<div id="controlCard" class="card hidden">
  <h2>Control Panel</h2>
  <p>Lamp 1: <span id="lamp1-status" class="status">...</span></p>
  <button onclick="toggleLamp('lamp1')">Toggle Lamp 1</button>
  <p>Lamp 2: <span id="lamp2-status" class="status">...</span></p>
  <button onclick="toggleLamp('lamp2')">Toggle Lamp 2</button>
  <button class="secondary" onclick="logout()" style="margin-top:20px;">Logout</button>
</div>

<!-- Settings Panel -->
<div id="settingsCard" class="card hidden">
  <h2>Settings</h2>

  <h3>Wi-Fi Configuration</h3>
  <button onclick="rescanWiFi()">Rescan Wi-Fi</button>
  <select id="wifiList"></select>
  <input type="password" id="wifiPassword" placeholder="Wi-Fi Password"/>
  <button onclick="connectWiFi()">Connect</button>

  <div id="adminSection" class="hidden">
    <h3>Add Allowed User</h3>
    <input type="email" id="newUserEmail" placeholder="User email"/>
    <button onclick="addUser()">Add User</button>
  </div>

  <button class="secondary" onclick="backToControl()">Back</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBTsypZYdo6spPGG9W9MEeckgcetefDP3M",
    authDomain: "h4xcontrol.firebaseapp.com",
    databaseURL: "https://h4xcontrol-default-rtdb.firebaseio.com",
    projectId: "h4xcontrol",
    storageBucket: "h4xcontrol.appspot.com",
    messagingSenderId: "1030967330576",
    appId: "1:1030967330576:web:ac3e4201a61b5bebea8795",
    measurementId: "G-Z20VN8LY3N"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const defaultAdmin = "contact@hashir.site";

  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("controlCard").classList.remove("hidden");

      updateStatus("lamp1");
      updateStatus("lamp2");

      if (user.email === defaultAdmin) {
        document.getElementById("adminSection").classList.remove("hidden");
      }
    } else {
      document.getElementById("loginCard").classList.remove("hidden");
      document.getElementById("controlCard").classList.add("hidden");
      document.getElementById("settingsCard").classList.add("hidden");
    }
  });

  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
  }

  function signup() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;

    db.ref("allowed_users").once("value").then(snap => {
      const allowed = snap.val() || {};
      if (email === defaultAdmin || allowed[email.replace(/\./g, "_")]) {
        auth.createUserWithEmailAndPassword(email, pass).catch(e => alert(e.message));
      } else {
        alert("This email is not allowed to register.");
      }
    });
  }

  function logout() {
    auth.signOut();
  }

  function toggleLamp(lamp) {
    const ref = db.ref(lamp);
    ref.once('value').then(snap => {
      ref.set(!snap.val());
    });
  }

  function updateStatus(lamp) {
    const el = document.getElementById(`${lamp}-status`);
    db.ref(lamp).on('value', snap => {
      const val = snap.val();
      el.textContent = val ? "ON" : "OFF";
      el.className = `status ${val ? 'on' : 'off'}`;
    });
  }

  function toggleSettings() {
    document.getElementById("controlCard").classList.add("hidden");
    document.getElementById("settingsCard").classList.remove("hidden");
  }

  function backToControl() {
    document.getElementById("settingsCard").classList.add("hidden");
    document.getElementById("controlCard").classList.remove("hidden");
  }

  function addUser() {
    const email = document.getElementById("newUserEmail").value;
    if (!email) return alert("Enter a valid email");
    const safeEmail = email.replace(/\./g, "_");
    db.ref("allowed_users/" + safeEmail).set(true).then(() => {
      alert("User allowed to register!");
      document.getElementById("newUserEmail").value = "";
    });
  }

  function rescanWiFi() {
    db.ref("commands/scan").set(true);
  }

  db.ref("wifi_list").on("value", snap => {
    const list = snap.val() || [];
    const wifiList = document.getElementById("wifiList");
    wifiList.innerHTML = "";
    list.forEach(ssid => {
      const option = document.createElement("option");
      option.text = ssid;
      option.value = ssid;
      wifiList.add(option);
    });
  });

  function connectWiFi() {
    const ssid = document.getElementById("wifiList").value;
    const password = document.getElementById("wifiPassword").value;
    if (!ssid || !password) return alert("Enter SSID and password");
    db.ref("wifi_config").set({ ssid, password });
    alert("Wi-Fi settings sent to NodeMCU");
  }
</script>

</body>
</html>
